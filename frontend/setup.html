<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Phiên Đấu Giá</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Font: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        body.loading .loading-overlay {
            display: flex;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            color: white;
        }
    </style>
    <script>
        console.log('Setting up demo mode...');
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
        });
    </script>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay">
        <div class="spinner-border loading-spinner" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
    </div>

    <main class="main">
        <div class="container py-5">
            <!-- Demo mode indicator -->
            <div class="alert alert-warning mb-4">
                <strong>Demo Mode</strong> - Running with mock data
                <button class="btn btn-sm btn-danger ms-2" id="resetDemoBtn" onclick="resetDemo()">
                    <i class="bi bi-arrow-clockwise"></i> Reset Demo
                </button>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">Tạo Phiên Đấu Giá</h1>
            </div>

            <!-- Setup Form -->
            <div class="card">
                <div class="card-body">
                    <form id="setupForm">
                        <div class="mb-3">
                            <label for="initialPrice" class="form-label">Giá Khởi Điểm</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="initialPrice" value="1,000,000" required>
                                <span class="input-group-text">VND</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="priceIncrement" class="form-label">Bước Giá</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="priceIncrement" value="50,000" required>
                                <span class="input-group-text">VND</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="auctionDuration" class="form-label">Thời Gian Phiên Đấu Giá</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="auctionDuration" min="1" value="5" required>
                                <span class="input-group-text">phút</span>
                            </div>
                        </div>

                        <!-- Add Bidder Form -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Thêm Người Tham Gia</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label for="bidderId" class="form-label">Mã Người Tham Gia</label>
                                        <input type="text" class="form-control" id="bidderId" placeholder="Ví dụ: B001">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="bidderName" class="form-label">Tên</label>
                                        <input type="text" class="form-control" id="bidderName" placeholder="Tên người tham gia">
                                    </div>
                                    <div class="col-md-5">
                                        <label for="bidderAddress" class="form-label">Địa Chỉ</label>
                                        <input type="text" class="form-control" id="bidderAddress" placeholder="Địa chỉ">
                                    </div>
                                </div>
                                <div class="text-end mt-3">
                                    <button type="button" class="btn btn-success" id="addBidderBtn" onclick="addBidder()">
                                        <i class="bi bi-plus-lg"></i> Thêm Người Tham Gia
                                    </button>
                                    <button type="button" class="btn btn-outline-primary ms-2" id="importBiddersBtn">
                                        <i class="bi bi-file-earmark-excel"></i> Nhập từ Excel
                                    </button>
                                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                                </div>
                            </div>
                        </div>

                        <!-- Bidders Section -->
                        <div class="mb-4">
                            <label class="form-label">Danh Sách Người Tham Gia</label>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="biddersTable">
                                    <thead>
                                        <tr>
                                            <th>Mã</th>
                                            <th>Tên</th>
                                            <th>Địa Chỉ</th>
                                            <th>Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="biddersTableBody">
                                        <!-- Sample bidders will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noBidders" class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>Chưa có người tham gia. Vui lòng thêm ít nhất 2 người tham gia.
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="backBtn" onclick="window.location.href='index.html'">
                                <i class="bi bi-arrow-left"></i> Quay Lại
                            </button>
                            <button type="button" class="btn btn-primary" id="startAuctionBtn" onclick="startAuction()">
                                <i class="bi bi-play-fill"></i> Bắt Đầu Đấu Giá
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast container for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Load environment config first -->
    <script src=".env.js"></script>

    <!-- Fallback direct script for demo mode -->
    <script>
        // Sample bidders array for demo mode
        let bidders = [
            { id: "B001", name: "Nguyễn Văn A", address: "123 Đường Lê Lợi, Hà Nội" },
            { id: "B002", name: "Trần Thị B", address: "456 Đường Nguyễn Huệ, TP.HCM" },
            { id: "B003", name: "Lê Văn C", address: "789 Đường Trần Phú, Đà Nẵng" }
        ];

        // Show loading overlay
        function showLoading() {
            document.body.classList.add('loading');
        }

        // Hide loading overlay
        function hideLoading() {
            document.body.classList.remove('loading');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">${type === 'error' ? 'Lỗi' : 'Thông báo'}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Đóng"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            toastContainer.appendChild(toast);

            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Format currency in VND
        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN');
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded - initializing setup page');
            // Load initial bidders
            renderBidders();

            // Initialize event handlers if not already set by the module script
            document.getElementById('importBiddersBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                showToast('Excel import is not supported in demo mode', 'info');
                e.target.value = '';
            });
        });

        // Add a bidder
        function addBidder() {
            console.log('Adding bidder (direct handler)');
            const bidderIdInput = document.getElementById('bidderId');
            const bidderNameInput = document.getElementById('bidderName');
            const bidderAddressInput = document.getElementById('bidderAddress');

            const id = bidderIdInput.value.trim();
            const name = bidderNameInput.value.trim();
            const address = bidderAddressInput.value.trim();

            if (!id || !name) {
                showToast('Vui lòng nhập đầy đủ thông tin', 'warning');
                return;
            }

            // Check for duplicate ID
            if (bidders.some(b => b.id === id)) {
                showToast('Mã người tham gia đã tồn tại', 'warning');
                return;
            }

            // Add bidder to array
            bidders.push({ id, name, address });

            // Clear inputs
            bidderIdInput.value = '';
            bidderNameInput.value = '';
            bidderAddressInput.value = '';

            // Re-render bidders list
            renderBidders();

            showToast('Thêm người tham gia thành công', 'success');
        }

        // Remove a bidder
        function removeBidder(id) {
            console.log('Removing bidder:', id);
            bidders = bidders.filter(b => b.id !== id);
            renderBidders();
            showToast('Đã xóa người tham gia', 'success');
        }

        // Render bidders table
        function renderBidders() {
            const tableBody = document.getElementById('biddersTableBody');
            const noBidders = document.getElementById('noBidders');

            // Clear table
            tableBody.innerHTML = '';

            if (bidders.length === 0) {
                noBidders.style.display = 'block';
                document.getElementById('startAuctionBtn').disabled = true;
            } else {
                noBidders.style.display = 'none';
                document.getElementById('startAuctionBtn').disabled = bidders.length < 2;

                // Add rows for each bidder
                bidders.forEach(bidder => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${bidder.id}</td>
                        <td>${bidder.name}</td>
                        <td>${bidder.address || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removeBidder('${bidder.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        // Reset demo data
        function resetDemo() {
            console.log('Resetting demo data');
            bidders = [
                { id: "B001", name: "Nguyễn Văn A", address: "123 Đường Lê Lợi, Hà Nội" },
                { id: "B002", name: "Trần Thị B", address: "456 Đường Nguyễn Huệ, TP.HCM" }
            ];

            document.getElementById('initialPrice').value = '1,000,000';
            document.getElementById('priceIncrement').value = '50,000';
            document.getElementById('auctionDuration').value = '5';

            renderBidders();
            showToast('Đã khôi phục dữ liệu demo', 'success');
        }

        // Start auction
        function startAuction() {
            console.log('Starting auction (direct handler)');

            if (bidders.length < 2) {
                showToast('Cần ít nhất 2 người tham gia để bắt đầu đấu giá', 'warning');
                return;
            }

            showLoading();

            // Save bidders to localStorage for demo mode
            localStorage.setItem('demo_bidders', JSON.stringify(bidders));

            // Save auction settings
            const initialPrice = document.getElementById('initialPrice').value.replace(/[,.]/g, '');
            const priceIncrement = document.getElementById('priceIncrement').value.replace(/[,.]/g, '');
            const auctionDuration = document.getElementById('auctionDuration').value;

            localStorage.setItem('demo_settings', JSON.stringify({
                initialPrice: parseInt(initialPrice),
                priceIncrement: parseInt(priceIncrement),
                auctionDuration: parseInt(auctionDuration)
            }));

            // Navigate to bid_demo.html instead of bid.html
            window.location.href = 'bid_demo.html';
        }
    </script>

    <!-- Custom JS -->
    <script type="module" src="js/setup.js"></script>
</body>
</html>
